name: 🚀 Fullstack HR App CI/CD

on:
  push:
    branches:
      - main

env:
  COMPOSE_PROJECT: hrapp
  COMPOSE_FILE: docker-compose.yaml

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
      - name: 🧾 Checkout Code
        uses: actions/checkout@v4

      - name: 🛑 Stop Old Containers (PowerShell)
        shell: pwsh
        run: |
          Write-Host "Stopping old containers (if any)..."
          try {
            docker compose -p $env:COMPOSE_PROJECT -f $env:COMPOSE_FILE down
          } catch {
            Write-Warning "Teardown failed or not needed"
          }

      - name: 🛠️ Build & Start Stack
        shell: pwsh
        run: |
          Write-Host "Building and starting containers..."
          docker compose -p $env:COMPOSE_PROJECT -f $env:COMPOSE_FILE up -d --build `
            db backend frontend prometheus grafana node-exporter loki promtail swagger nginx
          Start-Sleep -Seconds 30

      - name: ✅ Health Check - List Containers
        shell: pwsh
        run: docker ps

      - name: 📦 Export Logs (Optional)
        shell: pwsh
        run: |
          Write-Host "Exporting container logs..."
          mkdir logs
          docker compose -p $env:COMPOSE_PROJECT -f $env:COMPOSE_FILE logs > logs/docker.log
