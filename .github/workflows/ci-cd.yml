name: üöÄ Full Stack CI/CD - Git Bash

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  fullstack-deploy:
    runs-on: windows-latest

    defaults:
      run:
        shell: bash  # Use Git Bash

    env:
      COMPOSE_PROJECT: fullstack_hr
      COMPOSE_FILE: docker-compose.yaml

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: üîç Check Git Bash location
        run: which bash

      - name: üßπ Clean previous Docker containers (ignore errors)
        run: docker compose -p "$COMPOSE_PROJECT" -f "$COMPOSE_FILE" down || echo "Ignore errors"

      - name: üöÄ Start full stack services
        run: |
          docker compose -p "$COMPOSE_PROJECT" -f "$COMPOSE_FILE" up -d --build \
            db backend frontend prometheus grafana node-exporter loki promtail swagger nginx

          echo "Waiting for services to stabilize..."
          sleep 20

      - name: ‚úÖ Show running containers
        run: docker ps

      - name: üì¶ Stop services after build (optional)
        if: always()
        run: docker compose -p "$COMPOSE_PROJECT" -f "$COMPOSE_FILE" down || echo "Teardown ignored"
